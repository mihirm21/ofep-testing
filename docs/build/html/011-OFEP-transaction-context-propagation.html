<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transaction Context Propagation &mdash; OFEP-TESTING 1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            OFEP-TESTING
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Transaction Context Propagation</a></li>
<li><a class="reference internal" href="#state-approved">State: APPROVED</a></li>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#proposal">Proposal</a><ul>
<li><a class="reference internal" href="#register-transaction-context-propagator">Register Transaction Context Propagator</a></li>
<li><a class="reference internal" href="#set-transaction-context">Set Transaction Context</a></li>
<li><a class="reference internal" href="#get-transaction-context">Get Transaction Context</a></li>
<li><a class="reference internal" href="#context-merge-order">Context Merge Order</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OFEP-TESTING</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Transaction Context Propagation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/011-OFEP-transaction-context-propagation.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="transaction-context-propagation">
<h1>Transaction Context Propagation<a class="headerlink" href="#transaction-context-propagation" title="Permalink to this heading"></a></h1>
</section>
<section id="state-approved">
<h1>State: APPROVED<a class="headerlink" href="#state-approved" title="Permalink to this heading"></a></h1>
<p>Flag evaluation may be affected by <a class="reference external" href="https://openfeature.dev/docs/specification/sections/evaluation-context">evaluation context</a> data including global, client, invocation, and hook context.
Currently, developers are responsible for explicitly defining and supplying evaluation context during flag evaluation.
This proposal defines a new type of evaluation context called transaction context.</p>
<p><em>Transaction context</em>, is a container for transaction-specific evaluation context (e.g. user id, user agent, IP).
With transaction context propagation, a developer can set transaction context where it’s convenient (e.g. an auth service) and it will automatically be applied to all flag evaluations within a transaction (e.g. a request or thread). Transaction context will typically be propagated using a language-specific carrier such as thread local storage or another similar mechanism.</p>
<p>This proposal covers context propagation for a single transaction within a process.
Propagating evaluation context to child processes or services is out of scope of this OFEP.
However, a proof of concept for how OpenTelemetry baggage could be leverage can be found <a class="reference external" href="https://github.com/open-feature/playground/pull/142">here</a>.</p>
</section>
<section id="background">
<h1>Background<a class="headerlink" href="#background" title="Permalink to this heading"></a></h1>
<p>Many languages provide a mechanism for storing data for the length of a single transaction. This can be used to store transaction context that can be automatically merged with the evaluation context before flag evaluation. The implementation will vary by technology. For example, Java may use <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/lang/ThreadLocal.html">ThreadLocal</a>, Golang may use <a class="reference external" href="https://pkg.go.dev/context">Go Context</a>, and Node may use <a class="reference external" href="https://nodejs.org/api/async_hooks.html">async hooks</a>.</p>
</section>
<section id="proposal">
<h1>Proposal<a class="headerlink" href="#proposal" title="Permalink to this heading"></a></h1>
<p>This proposal introduces a way to register a transaction context propagator to the global OpenFeature API. Once registered, transaction context can be augmented or mutated at any point in the transaction. When a flag is evaluated, the transaction context is merged with evaluation context based on the merge order defined below.</p>
<section id="register-transaction-context-propagator">
<h2>Register Transaction Context Propagator<a class="headerlink" href="#register-transaction-context-propagator" title="Permalink to this heading"></a></h2>
<p>In some runtimes (e.g. node), there isn’t a native solution for transaction context propagation that would work in all situations. For that reason, it would be beneficial to provide the ability to register a transaction propagator on the global OpenFeature API.</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * An example transaction context manager that utilizes async_hooks added in</span>
<span class="cm"> * node 12.17 and marked as stable in node 16.4</span>
<span class="cm"> */</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">AsyncLocalStorageTransactionContext</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">TransactionContextManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">asyncLocalStorage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AsyncLocalStorage</span><span class="o">&lt;</span><span class="nx">EvaluationContext</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">  </span><span class="nx">getTransactionContext</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">EvaluationContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">asyncLocalStorage</span><span class="p">.</span><span class="nx">getStore</span><span class="p">()</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setTransactionContext</span><span class="p">(</span>
<span class="w">    </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">EvaluationContext</span><span class="p">,</span>
<span class="w">    </span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">asyncLocalStorage</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">OpenFeature</span><span class="p">.</span><span class="nx">setTransactionContextPropagator</span><span class="p">(</span>
<span class="w">  </span><span class="ow">new</span><span class="w"> </span><span class="nx">AsyncLocalStorageTransactionContext</span><span class="p">()</span>
<span class="p">);</span>
</pre></div>
</div>
</section>
<section id="set-transaction-context">
<h2>Set Transaction Context<a class="headerlink" href="#set-transaction-context" title="Permalink to this heading"></a></h2>
<p>Setting transaction context will vary based on the language. In JavaScript, it may look like this:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * This example is based on an express middleware.</span>
<span class="cm"> */</span>
<span class="nx">use</span><span class="p">(</span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">_res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">OpenFeature</span><span class="p">.</span><span class="nx">setTransactionContext</span><span class="p">({</span><span class="w"> </span><span class="nx">targetingKey</span><span class="o">:</span><span class="w"> </span><span class="kt">req.user.id</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>NOTE: Setting the same property multiple times will override the previous value.</p>
</div></blockquote>
</section>
<section id="get-transaction-context">
<h2>Get Transaction Context<a class="headerlink" href="#get-transaction-context" title="Permalink to this heading"></a></h2>
<p>Getting transaction context happens automatically in the OpenFeature client before flag evaluation occurs.</p>
</section>
<section id="context-merge-order">
<h2>Context Merge Order<a class="headerlink" href="#context-merge-order" title="Permalink to this heading"></a></h2>
<p>Transaction context merging should happen between global context and client context. This provides a reasonable balance between context inheritance and the ability to override context properties.</p>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span>flowchart LR
  global(&quot;API (global)&quot;)
  transaction(&quot;Transaction&quot;)
  client(&quot;Client&quot;)
  invocation(&quot;Invocation&quot;)
  hook(&quot;Before Hooks&quot;)
  global --&gt; transaction
  transaction --&gt; client
  client --&gt; invocation
  invocation --&gt; hook
</pre></div>
</div>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>[X] <a class="reference external" href="https://github.com/open-feature/js-sdk/pull/212">Example implementation in Node</a></p></li>
<li><p>[ ] Example implementation in Golang</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Mihir Mittal.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>